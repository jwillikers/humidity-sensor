= Humidity Sensor CircuitPython
Jordan Williams <jordan@jwillikers.com>
:experimental:
:icons: font
ifdef::env-github[]
:tip-caption: :bulb:
:note-caption: :information_source:
:important-caption: :heavy_exclamation_mark:
:caution-caption: :fire:
:warning-caption: :warning:
endif::[]
:Adafruit-CircuitPython-framebuf: https://github.com/adafruit/Adafruit_CircuitPython_framebuf[Adafruit CircuitPython framebuf]
:Adafruit-Feather-RP2040: https://learn.adafruit.com/adafruit-feather-rp2040-pico[Adafruit Feather RP2040]
:Asciidoctor_: https://asciidoctor.org/[Asciidoctor]
:CircuitPython: https://circuitpython.org/[CircuitPython]
:Fedora: https://getfedora.org/[Fedora]
:Fedora-Silverblue: https://silverblue.fedoraproject.org/[Fedora Silverblue]
:fish: https://fishshell.com/[fish]
:Git: https://git-scm.com/[Git]
:Linux: https://www.linuxfoundation.org/[Linux]
:MicroPython: https://micropython.org/[MicroPython]
:pip-tools: https://github.com/jazzband/pip-tools[pip-tools]
:pipkin: https://github.com/aivarannamaa/pipkin[pipkin]
:pre-commit: https://pre-commit.com/[pre-commit]
:Python: https://www.python.org/[Python]

image:https://github.com/jwillikers/humidity-sensor-circuitpython/workflows/CI/badge.svg["Build Status", link="https://github.com/jwillikers/humidity-sensor-circuitpython/actions?query=workflow%3ACI"]
image:https://img.shields.io/badge/pre--commit-enabled-brightgreen?logo=pre-commit&logoColor=white[pre-commit, link=https://github.com/pre-commit/pre-commit]

A simple humidity sensor using the {Adafruit-Feather-RP2040}, monochrome eInk Display FeatherWing, and HTU31D humidity sensor, written in {MicroPython}.

ifdef::env-github[]
++++
<p align="center">
  <img  alt="Humidity Sensor" src="pics/Humidity Sensor Top.jpg?raw=true"/>
</p>
<p align="center">
  <img  alt="Humidity Sensor Demo" src="pics/Humidity Sensor Demo.gif?raw=true"/>
</p>
++++
endif::[]

ifndef::env-github[]
image::pics/Humidity Sensor Top.jpg[Humidity Sensor, align=center]
image::pics/Humidity Sensor Demo.gif[Humidity Sensor Demo, align=center]
endif::[]

== Hardware

The hardware components comprising the humidity sensory are listed below.

.Humidity Sensor Components
* https://www.adafruit.com/product/4195[Adafruit 2.13" Monochrome eInk / ePaper Display FeatherWing - 250x122 Monochrome with SSD1680]
* https://www.adafruit.com/product/4884[Adafruit RP2040 Feather]
* https://www.adafruit.com/product/1570[Lithium Ion Polymer Battery - 3.7v 100mAh]
* https://www.adafruit.com/product/4832[HTU31D Humidity Sensor]
* https://www.adafruit.com/product/2830[Stacking Headers for Feather - 12-pin and 16-pin female headers]
* https://www.adafruit.com/product/4399[STEMMA QT / Qwiic JST SH 4-Pin Cable - 50mm Long]

Programming will require a USB-C cable and a computer.

== How it Works

The humidity sensor samples the relative humidity and temperature once every second.
After five minutes, it finds the median of these values and updates the readings shown on the display.
A median is simple and accounts for outliers, making the displayed readings more consistent than one-off samples.
When the humidity sensor starts up, it immediately displays the value of a single reading from sensor.
This avoids undue delays for users.

== Shortcomings

Efficiency::
The battery life is abysmal.
The 105 mAh battery fails to sustain this power-hungry machine for more than several hours.
I'm hoping to get closer to a week's worth of life out of a single battery life.
Improvements to energy efficiency include the following.
+
.Power Optimizations
- [ ] Lower the clock speed.
- [ ] Store sensor readings with Direct Memory Access, aka _DMA_, to avoid waking the microcontroller as frequently.
Unfortunately, I don't believe this functionality is available in CircuitPython at this time.
- [ ] Put the RP2040 into deep sleep, waking only to refresh the screen.
If values must be stored in non-volatile memory, consider using an FRAM breakout instead of the onboard EEPROM.
- [ ] Increase the interval between updates of the screen.
- [ ] Cut the line to the LED on the humidity sensor breakout.

Deployment::
The required libraries are deployed with {pipkin}.
The required font bitmap used by this project is from the {Adafruit-CircuitPython-framebuf} example.
Simply install the `code.py` file and `font/font5x8.bin` to the board's root directory.

== Getting Started

The instructions here setup the software for the Feather RP2040.
It is assumed that you are on and familiar with Linux and using CircuitPython on microcontrollers.
{Fedora-Silverblue} 36 is used as the reference operating system and the {fish} shell is used.

[TIP]
====
To access the serial connection to the Feather RP2040 without requiring superuser privileges, add your user to the `dialout` group.

[,sh]
----
sudo usermod -a -G dialout $USER
----

Now restart for the change to take effect.
====

. First, configure the Feather RP2040 for CircuitPython by installing the latest UF2 bootloader.
This project was last tested with version 7.2.5 of CircuitPython.
The CircuitPython bootloader for the Feather RP2040 is available on the https://micropython.org/download/ADAFRUIT_FEATHER_RP2040/[Feather RP2040 MicroPython Download page].
+
[,sh]
----
wget -qLP ~/Downloads https://micropython.org/resources/firmware/ADAFRUIT_FEATHER_RP2040-20220117-v1.18.uf2
----

. Hold down the button marked _bootsel_ on the Feather RP2040 while plugging it in to your computer with a USB-C cable.
The RP2040 should automatically be mounted as a disk on your computer.
In my case, it has been mounted at `/run/media/jordan/RPI-RP2`.
The lsblk command can be used to find where it has been mounted
+
[,sh]
----
lsblk
----

. Now copy over the UF2 bootloader to the RP2040.
+
[,sh]
----
cp ~/Downloads/ADAFRUIT_FEATHER_RP2040-20220117-v1.18.uf2 /run/media/$USER/RPI-RP2/
----

. Wait for the file to finish copying.
When it is done, a serial console will become available which provides access to the QT Py RP2040.
This serial port can be found with the `dmesg` command as follows.
+
--
[source,sh]
----
dmesg | tail
[  443.276661] usb 1-4.3.2: reset high-speed USB device number 22 using xhci_hcd
[ 2180.628239] usb 1-3.2: USB disconnect, device number 10
[ 4242.965271] usb 1-3.1: USB disconnect, device number 6
[ 4245.247932] usb 1-3.1: new full-speed USB device number 23 using xhci_hcd
[ 4245.387678] usb 1-3.1: New USB device found, idVendor=2e8a, idProduct=0005, bcdDevice= 1.00
[ 4245.387681] usb 1-3.1: New USB device strings: Mfr=1, Product=2, SerialNumber=3
[ 4245.387682] usb 1-3.1: Product: Board in FS mode
[ 4245.387683] usb 1-3.1: Manufacturer: MicroPython
[ 4245.387684] usb 1-3.1: SerialNumber: df6050788b1e1c2e
[ 4245.397678] cdc_acm 1-3.1:1.0: ttyACM0: USB ACM device
----

`ttyACM0` in the preceding output indicates the device node.
This device resides under `/dev` on the filesystem.
Note the name of the device shown in your output, since it will be used to copy the source code to the QT Py's on-board filesystem.
--

. Clone this project's repository.
+
[,sh]
----
git clone https://github.com/jwillikers/humidity-sensor-circuitpython.git
----

. Change to the project's root directory. 
+
[,sh]
----
cd humidity-sensor-micropython
----

. Create a virtual environment for the project.
+
[,sh]
----
python -m venv .env
----

. Activate the virtual environment.
+
[,sh]
----
source .env/bin/activate.fish
----

. Install the development dependencies.
+
[,sh]
----
python -m pip install -r requirements-dev.txt
----

. Install the necessary libraries on the microcontroller using {pipkin}.
+
[,sh]
----
pipkin -p /dev/ttyACM0 install --compile -r requirements-circuitpython.txt
----

. Download the MicroPython `pyboard.py` script for accessing the QT Py RP2040.
+
[,sh]
----
wget -L https://raw.githubusercontent.com/micropython/micropython/master/tools/pyboard.py
----

. Copy the `main.py` source code file to the QT Py RP2040.
+
[,sh]
----
python pyboard.py --device /dev/ttyACM0 -f cp main.py font/font5x8.bin :
----

. Exit the project's virtual environment.
+
[,sh]
----
exit
----

== Development

It's recommended to use the provided {pre-commit} checks when developing.

. Activate the virtual environment.
+
[,sh]
----
source .env/bin/activate.fish
----

. Install the development packages.
+
[,sh]
----
python -m pip install -r requirements-dev.txt
----

. Install the packages available for CPython directly on your computer.
This enables tools and editors to better verify that the libraries are being used properly.
This project uses pip-tools to synchronize virtual environments for development.
Sync your virtual environments packages with those pinned in the `requirements.txt` and `requirements-dev.txt` files with the `pip-sync` command.
+
[,sh]
----
pip-sync requirements-dev.txt requirements.txt
----

. Install the Git hooks for pre-commit.
+
[,sh]
----
pre-commit install
----

. Upgrade the packages pinned in the `requirements.txt` file with the `pip-compile` command.
+
[,sh]
----
pip-compile \
  --allow-unsafe \
  --generate-hashes \
  --reuse-hashes \
  --upgrade \
  requirements.in
----

. The pinned development packages in the `requirements-dev.txt` file can be upgraded in the same fashion.
+
[,sh]
----
pip-compile \
  --allow-unsafe \
  --generate-hashes \
  --reuse-hashes \
  --upgrade \
  requirements-dev.in
----

. Update the CircuitPython dependencies in `requirements-circuitpython.txt` by running the `pip-compile` command and removing all the dependencies that don't contain `adafruit-circuitpython` in the name.
The following command will do all of this with the help of a couple command-line options and Awk.
+
[,sh]
----
pip-compile \
    --allow-unsafe \
    --generate-hashes \
    --no-annotate \
    --no-header \
    --output-file requirements-circuitpython.txt \
    --reuse-hashes \
    --upgrade \
    requirements.in; \
  and awk \
    -i inplace \
    '/adafruit-circuitpython/ || /adafruit-blinka/ {c=2} c&&c--' \
    requirements-circuitpython.txt
----

== Documentation

.CircuitPython Documentation
* https://circuitpython.readthedocs.io/en/latest/shared-bindings/alarm/index.html[alarm]
* https://circuitpython.readthedocs.io/projects/epd/en/latest/[epd]
* https://circuitpython.readthedocs.io/projects/framebuf/en/latest/[framebuf]
* https://circuitpython.readthedocs.io/projects/htu31d/en/latest/[htu31d]
* https://circuitpython.readthedocs.io/en/latest/shared-bindings/neopixel_write/index.html[neopixel_write]

.MicroPython Documentation
* https://docs.micropython.org/en/latest/rp2/quickref.html

== Contributing

Contributions in the form of issues, feedback, and even pull requests are welcome.
Make sure to adhere to the project's link:CODE_OF_CONDUCT.adoc[Code of Conduct].

== Open Source Software

This project is built on the hard work of countless open source contributors.
Several of these projects are enumerated below.

* {Asciidoctor_}
* {CircuitPython}
* {Fedora}
* {Fedora-Silverblue}
* {fish}
* {Git}
* {MicroPython}
* {Linux}
* {pip-tools}
* {pipkin}
* {pre-commit}
* {Python}

== Code of Conduct

Refer to the project's link:CODE_OF_CONDUCT.adoc[Code of Conduct] for details.

== License

The font bitmap, link:font/font5x8.bin[font/font5x8.bin], is © 2021 ladyada for Adafruit Industries and licensed under the MIT license.

This repository is licensed under the https://www.gnu.org/licenses/gpl-3.0.html[GPLv3], a copy of which is provided link:LICENSE.adoc[here].

© 2021-2022 Jordan Williams

== Authors

mailto:{email}[{author}]
